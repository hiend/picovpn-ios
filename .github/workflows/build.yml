name: Build PicoVPN

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: |
        # GitHub Actions MacOS 14 имеет Xcode 16.1 по умолчанию
        xcodebuild -version

    - name: Download Xray.xcframework
      run: |
        curl -L -o LibXray.xcframework.zip https://github.com/wanliyunyan/LibXray/releases/download/25.12.8/LibXray.xcframework.zip
        unzip -q LibXray.xcframework.zip
        mv LibXray.xcframework Xray.xcframework
        rm LibXray.xcframework.zip

    - name: Create module.modulemap for Xray
      run: |
        for dir in Xray.xcframework/*/; do
          if [ -d "${dir}Headers" ]; then
            cat > "${dir}Headers/module.modulemap" << 'EOF'
        module Xray {
            header "libXray.h"
            export *
        }
        EOF
            echo "Created module.modulemap in ${dir}Headers/"
          fi
        done

    - name: Build PicoVPN
      run: |
        xcodebuild -scheme PicoVPN \
          -configuration Release \
          -sdk iphoneos \
          -archivePath ./build/PicoVPN.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          FRAMEWORK_SEARCH_PATHS="\$(inherited) \$(PROJECT_DIR)"

    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: PicoVPN.xcarchive
        path: build/PicoVPN.xcarchive
